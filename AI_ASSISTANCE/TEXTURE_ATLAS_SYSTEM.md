# Texture Atlas System in NeoForge 1.21.1

## Overview

This document details the texture atlas system implementation used in ChemLibMekanized, which successfully loads 296+ chemical item textures using an efficient layered approach.

## Architecture

### Layered Texture System

ChemLibMekanized uses a **layered texture approach** that efficiently serves hundreds of chemical items with minimal texture files:

```
18 PNG Base Textures → 296+ Chemical Items
```

**Base Layer Files** (`/assets/chemlibmekanized/textures/items/`):
```
element_solid_layer_0.png    + element_solid_layer_1.png
element_liquid_layer_0.png   + element_liquid_layer_1.png
element_gas_layer_0.png      + element_gas_layer_1.png
compound_solid_layer_0.png   + compound_solid_layer_1.png
compound_liquid_layer_0.png  + compound_liquid_layer_1.png
compound_gas_layer_0.png     + compound_gas_layer_1.png
compound_dust_layer_0.png    + compound_dust_layer_1.png
bucket_layer_0.png           + bucket_layer_1.png
gas_bucket_layer_0.png       + gas_bucket_layer_1.png
```

### Template Model System

**Template Models** (`/assets/chemlibmekanized/models/item/`):
```json
{
  "parent": "minecraft:item/generated",
  "textures": {
    "layer0": "chemlibmekanized:items/element_solid_layer_0",
    "layer1": "chemlibmekanized:items/element_solid_layer_1"
  }
}
```

**Individual Chemical Models**:
```json
{
  "parent": "chemlibmekanized:item/element_solid_model"
}
```

### Color Tinting System

Each chemical item implements dynamic color tinting:

```java
public class ExtractedElementItem extends Item {
    private final ChemicalElement element;

    @Override
    public int getColor(ItemStack stack, int tintIndex) {
        // Layer 0 gets chemical-specific color, Layer 1 stays white
        return tintIndex > 0 ? -1 : element.getColor();
    }
}
```

**Color Provider Registration**:
```java
@SubscribeEvent
static void onRegisterItemColors(RegisterColorHandlersEvent.Item event) {
    // Register color handlers for all chemical items
    for (RegistryObject<Item> item : ELEMENT_ITEMS.getEntries()) {
        if (item.get() instanceof ExtractedElementItem elementItem) {
            event.register(elementItem::getColor, item.get());
        }
    }
}
```

## Atlas Configuration

### SpriteSourceProvider Implementation

```java
public class ChemLibSpriteSourceProvider extends SpriteSourceProvider {

    public ChemLibSpriteSourceProvider(PackOutput output,
                                      CompletableFuture<HolderLookup.Provider> lookupProvider,
                                      ExistingFileHelper existingFileHelper) {
        super(output, lookupProvider, ChemlibMekanized.MODID, existingFileHelper);
    }

    @Override
    protected void gather() {
        // Add our custom layer textures to the blocks atlas
        // Items in NeoForge 1.21.1 use the blocks atlas for textures
        SourceList blocksAtlas = atlas(BLOCKS_ATLAS);

        // Add all our layer textures to the blocks atlas
        blocksAtlas.addSource(new DirectoryLister("items", "items/"));
    }
}
```

### Generated Atlas Configuration

The datagen produces `/assets/minecraft/atlases/blocks.json`:
```json
{
  "sources": [
    {
      "type": "minecraft:directory",
      "prefix": "items/",
      "source": "items"
    }
  ]
}
```

## File Organization

### Source Structure
```
src/main/resources/assets/chemlibmekanized/
├── textures/items/                    # Layer texture files
│   ├── element_solid_layer_0.png     # Base shape (gets tinted)
│   ├── element_solid_layer_1.png     # Details/highlights (white)
│   ├── compound_gas_layer_0.png      # Different shapes per matter state
│   └── ...
├── models/item/                       # Model definitions
│   ├── element_solid_model.json      # Template models
│   ├── compound_gas_model.json
│   ├── hydrogen.json                 # Individual items inherit templates
│   ├── oxygen.json
│   └── ...
└── atlases/                          # ❌ OBSOLETE in NeoForge 1.21.1
    └── items.json                    # Don't use manual atlas files
```

### Generated Structure
```
src/generated/resources/assets/minecraft/
└── atlases/
    └── blocks.json                   # ✅ Generated by SpriteSourceProvider
```

## Chemical Matter State Mapping

| ChemLib State | Template Model | Layer Textures |
|---------------|----------------|----------------|
| `SOLID` (element) | `element_solid_model.json` | `element_solid_layer_0/1.png` |
| `LIQUID` (element) | `element_liquid_model.json` | `element_liquid_layer_0/1.png` |
| `GAS` (element) | `element_gas_model.json` | `element_gas_layer_0/1.png` |
| `SOLID` (compound) | `compound_solid_model.json` | `compound_solid_layer_0/1.png` |
| `LIQUID` (compound) | `compound_liquid_model.json` | `compound_liquid_layer_0/1.png` |
| `GAS` (compound) | `compound_gas_model.json` | `compound_gas_layer_0/1.png` |
| `DUST` (compound) | `compound_dust_model.json` | `compound_dust_layer_0/1.png` |

## Performance Metrics

### Atlas Efficiency
- **Input**: 18 PNG files (~2MB total)
- **Output**: 296+ chemical item textures
- **Atlas Size**: 2048x2048x4 (16MB VRAM)
- **Efficiency Ratio**: 16.4 items per texture file

### Load Time Impact
- **No "Missing texture" errors**: ✅
- **Clean atlas creation**: ✅ `Created: 2048x2048x4 minecraft:textures/atlas/blocks.png-atlas`
- **Automatic template loading**: ✅ No explicit model registration required

## Debugging Atlas Issues

### Common Error Patterns

**Missing Texture Error**:
```
Missing textures in model chemlibmekanized:calcium#inventory:
    minecraft:textures/atlas/blocks.png:chemlibmekanized:items/element_solid_layer_0
    minecraft:textures/atlas/blocks.png:chemlibmekanized:items/element_solid_layer_1
```

**Root Causes**:
1. `SpriteSourceProvider` not registered in datagen
2. Datagen not run after atlas changes (`./gradlew runData`)
3. Texture files missing from `/textures/items/` directory
4. Wrong atlas target (trying to use items atlas instead of blocks atlas)

### Debug Commands

```bash
# Check atlas loading
./gradlew runClient 2>&1 | grep -E "(Created:|Missing texture|atlas)"

# Verify datagen
./gradlew runData 2>&1 | grep -E "(Gathering sprite|Added.*directory)"

# Check texture files
find src/main/resources/assets/*/textures/items/ -name "*.png" | wc -l
```

### Expected Log Output

**Successful Atlas Loading**:
```
[INFO] [ChemLibSpriteSourceProvider]: Gathering sprite sources for ChemLib textures
[INFO] [ChemLibSpriteSourceProvider]: Added ChemLib texture directory to blocks atlas
[INFO] [TextureAtlas]: Created: 2048x2048x4 minecraft:textures/atlas/blocks.png-atlas
```

## Integration with Mekanism

The texture system integrates seamlessly with Mekanism's chemical system:

```java
// Chemical items display proper textures in Mekanism machines
Gas hydrogen = MekanismAPI.gasRegistry().getValue(new ResourceLocation("chemlibmekanized", "hydrogen"));
// Texture will render correctly in Mekanism GUIs and world
```

## Best Practices

1. **Use DirectoryLister**: Include entire texture directories rather than individual files
2. **Target Blocks Atlas**: Always use `BLOCKS_ATLAS` for item textures in NeoForge 1.21.1
3. **Run Datagen**: Always run `./gradlew runData` after texture changes
4. **Monitor Atlas Size**: Large atlases consume more VRAM - organize efficiently
5. **Test Thoroughly**: Verify textures load in both inventory and world rendering
6. **Layered Design**: Use layer 0 for colored base shapes, layer 1 for white details

## Future Enhancements

### Element Indicators
The current system could be extended to add element abbreviations (H, He, Li, etc.) as a third texture layer or overlay system.

### Animation Support
The atlas system supports animated textures through `.mcmeta` files for special visual effects.

### Dynamic Loading
Future versions could implement dynamic texture generation for procedural chemical combinations.

This texture atlas system provides a robust, scalable foundation for chemical item rendering in Minecraft mods, efficiently handling hundreds of items while maintaining high visual quality and performance.